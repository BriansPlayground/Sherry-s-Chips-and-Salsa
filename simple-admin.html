<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin - Sherry's Eats</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        
        .admin-section {
            background: white;
            border-radius: 10px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .section-title {
            color: #DC143C;
            font-size: 24px;
            margin-bottom: 20px;
            border-bottom: 2px solid #DC143C;
            padding-bottom: 10px;
        }
        
        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr auto;
            gap: 15px;
            align-items: end;
            margin-bottom: 20px;
        }
        
        .form-group {
            display: flex;
            flex-direction: column;
        }
        
        .form-group label {
            font-weight: bold;
            margin-bottom: 5px;
            color: #333;
        }
        
        .form-group select,
        .form-group input {
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
        }
        
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            font-weight: bold;
        }
        
        .btn-primary {
            background: #DC143C;
            color: white;
        }
        
        .btn-primary:hover {
            background: #B8121F;
        }
        
        .btn-danger {
            background: #dc3545;
            color: white;
        }
        
        .btn-danger:hover {
            background: #c82333;
        }
        
        .dates-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }
        
        .date-card {
            border: 2px solid #ddd;
            border-radius: 8px;
            padding: 15px;
            background: #f8f9fa;
        }
        
        .date-card h4 {
            margin: 0 0 10px 0;
            color: #DC143C;
        }
        
        .date-info {
            font-size: 14px;
            color: #666;
            margin-bottom: 10px;
        }
        
        .orders-list {
            margin-top: 15px;
        }
        
        .order-item {
            background: white;
            border: 1px solid #ddd;
            border-radius: 5px;
            padding: 10px;
            margin-bottom: 10px;
            font-size: 14px;
        }
        
        .order-customer {
            font-weight: bold;
            color: #333;
        }
        
        .order-details {
            color: #666;
            margin-top: 5px;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background: #DC143C;
            color: white;
            border-radius: 10px;
            padding: 20px;
            text-align: center;
        }
        
        .stat-number {
            font-size: 32px;
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .stat-label {
            font-size: 14px;
            opacity: 0.9;
        }
    </style>
</head>
<body>
    <h1 style="text-align: center; color: #DC143C; margin-bottom: 30px;">Sherry's Eats - Admin Dashboard</h1>
    
    <!-- Stats -->
    <div class="stats-grid">
        <div class="stat-card">
            <div class="stat-number" id="total-orders">0</div>
            <div class="stat-label">Total Orders</div>
        </div>
        <div class="stat-card">
            <div class="stat-number" id="today-orders">0</div>
            <div class="stat-label">Today's Orders</div>
        </div>
        <div class="stat-card">
            <div class="stat-number" id="total-revenue">$0</div>
            <div class="stat-label">Total Revenue</div>
        </div>
        <div class="stat-card">
            <div class="stat-number" id="pending-orders">0</div>
            <div class="stat-label">Pending Orders</div>
        </div>
    </div>
    
    <!-- Add Delivery Date -->
    <div class="admin-section">
        <h2 class="section-title">Add Delivery Date</h2>
        <div class="form-row">
            <div class="form-group">
                <label for="new-city">City:</label>
                <select id="new-city">
                    <option value="">Select City...</option>
                    <option value="Metamora">Metamora</option>
                    <option value="Davison">Davison</option>
                    <option value="Lapeer">Lapeer</option>
                    <option value="Imlay City">Imlay City</option>
                    <option value="Capac">Capac</option>
                    <option value="Armada">Armada</option>
                    <option value="Waterford">Waterford</option>
                    <option value="Clarkston">Clarkston</option>
                    <option value="Oxford">Oxford</option>
                    <option value="Lake Orion">Lake Orion</option>
                    <option value="Auburn Hills">Auburn Hills</option>
                </select>
            </div>
            <div class="form-group">
                <label for="new-date">Date:</label>
                <input type="date" id="new-date">
            </div>
            <div class="form-group">
                <label for="new-time">Time:</label>
                <input type="time" id="new-time" value="14:00">
            </div>
            <div class="form-group">
                <button class="btn btn-primary" onclick="addDeliveryDate()">Add Date</button>
            </div>
        </div>
    </div>
    
    <!-- Delivery Dates -->
    <div class="admin-section">
        <h2 class="section-title">Upcoming Deliveries</h2>
        <div id="delivery-dates-list">
            <!-- Delivery dates will be populated here -->
        </div>
    </div>
    
    <!-- Recent Orders -->
    <div class="admin-section">
        <h2 class="section-title">Recent Orders</h2>
        <div id="recent-orders">
            <!-- Orders will be populated here -->
        </div>
    </div>

    <script>
        // Load data on page load
        document.addEventListener('DOMContentLoaded', function() {
            loadStats();
            loadDeliveryDates();
            loadRecentOrders();
        });
        
        function loadStats() {
            fetch('/api/business-metrics')
                .then(response => response.json())
                .then(data => {
                    document.getElementById('total-orders').textContent = data.totalOrders || 0;
                    document.getElementById('today-orders').textContent = data.todayOrders || 0;
                    document.getElementById('total-revenue').textContent = '$' + (data.totalRevenue || 0).toFixed(2);
                    document.getElementById('pending-orders').textContent = data.pendingOrders || 0;
                })
                .catch(error => {
                    console.error('Error loading stats:', error);
                });
        }
        
        function loadDeliveryDates() {
            fetch('/api/events')
                .then(response => response.json())
                .then(events => {
                    const container = document.getElementById('delivery-dates-list');
                    
                    if (events.length === 0) {
                        container.innerHTML = '<p>No delivery dates scheduled.</p>';
                        return;
                    }
                    
                    // Group events by date
                    const groupedEvents = {};
                    events.forEach(event => {
                        const date = event.event_date ? event.event_date.split('T')[0] : null;
                        if (date) {
                            if (!groupedEvents[date]) {
                                groupedEvents[date] = [];
                            }
                            groupedEvents[date].push(event);
                        }
                    });
                    
                    // Display grouped events
                    container.innerHTML = Object.keys(groupedEvents)
                        .sort()
                        .map(date => {
                            const eventsForDate = groupedEvents[date];
                            return `
                                <div class="date-card">
                                    <h4>${new Date(date).toLocaleDateString('en-US', { 
                                        weekday: 'long', 
                                        year: 'numeric', 
                                        month: 'long', 
                                        day: 'numeric' 
                                    })}</h4>
                                    ${eventsForDate.map(event => `
                                        <div class="date-info">
                                            <strong>${event.location}</strong> - ${event.title}
                                            <button class="btn btn-danger" style="float: right; padding: 5px 10px; font-size: 12px;" 
                                                    onclick="deleteEvent(${event.id})">Delete</button>
                                        </div>
                                    `).join('')}
                                </div>
                            `;
                        }).join('');
                })
                .catch(error => {
                    console.error('Error loading delivery dates:', error);
                    document.getElementById('delivery-dates-list').innerHTML = '<p>Error loading delivery dates.</p>';
                });
        }
        
        function loadRecentOrders() {
            fetch('/api/orders')
                .then(response => response.json())
                .then(orders => {
                    const container = document.getElementById('recent-orders');
                    
                    if (orders.length === 0) {
                        container.innerHTML = '<p>No orders yet.</p>';
                        return;
                    }
                    
                    // Show last 10 orders
                    const recentOrders = orders.slice(0, 10);
                    
                    container.innerHTML = recentOrders.map(order => `
                        <div class="order-item">
                            <div class="order-customer">
                                ${order.customer.first_name} ${order.customer.last_name}
                            </div>
                            <div class="order-details">
                                ${order.delivery.city} - ${new Date(order.delivery.date).toLocaleDateString()} - $${order.total.toFixed(2)}
                            </div>
                        </div>
                    `).join('');
                })
                .catch(error => {
                    console.error('Error loading orders:', error);
                    document.getElementById('recent-orders').innerHTML = '<p>Error loading orders.</p>';
                });
        }
        
        function addDeliveryDate() {
            const city = document.getElementById('new-city').value;
            const date = document.getElementById('new-date').value;
            const time = document.getElementById('new-time').value;
            
            if (!city || !date) {
                alert('Please select a city and date.');
                return;
            }
            
            const eventData = {
                title: `${city} Delivery`,
                description: `Weekly delivery to ${city} area`,
                event_date: `${date}T${time}:00`,
                location: city
            };
            
            fetch('/api/events', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(eventData)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('Delivery date added successfully!');
                    // Clear form
                    document.getElementById('new-city').value = '';
                    document.getElementById('new-date').value = '';
                    document.getElementById('new-time').value = '14:00';
                    // Reload data
                    loadDeliveryDates();
                } else {
                    alert('Error adding delivery date.');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error adding delivery date.');
            });
        }
        
        function deleteEvent(eventId) {
            if (confirm('Are you sure you want to delete this delivery date?')) {
                fetch(`/api/events/${eventId}`, {
                    method: 'DELETE'
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        alert('Delivery date deleted successfully!');
                        loadDeliveryDates();
                    } else {
                        alert('Error deleting delivery date.');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('Error deleting delivery date.');
                });
            }
        }
        
        // Set default date to tomorrow
        const tomorrow = new Date();
        tomorrow.setDate(tomorrow.getDate() + 1);
        document.getElementById('new-date').value = tomorrow.toISOString().split('T')[0];
    </script>
</body>
</html>
